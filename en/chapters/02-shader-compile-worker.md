# Shader compile job 调度与 ShaderCompileWorker 概览 (UE5.2 草稿)

本文档为草稿，目的是记录在 Unreal Engine 5.2 中 shader 编译调度（以 `ShaderCommonCompile` 为中心概念）如何分配编译任务（job），以及 `ShaderCompileWorker` 进程/模块的职责与工作流程。后续我会把需要精确代码引用的地方标注为 TODO，等你把理解补上或让我进一步抓取源代码路径并填充具体实现细节。

## 目标读者

- 渲染/引擎工程师，已经熟悉 UE 的编译流程，想了解 shader 编译任务如何被排队、分派以及如何与远程/本地 worker 协作。

## 概览

- 在 UE5.2 中，shader 编译是一系列独立但互相关联的编译任务（job）。这些 job 通常由上层系统（Material/Shader 系统）创建，随后进入到统一的调度系统。
- 调度系统负责：任务排队、优先级管理、合并/分批提交、在本地线程池上执行，或派发到独立的 `ShaderCompileWorker` 进程/远程 worker（用于并行与分布式编译）。

## 主要概念/数据结构（术语）

- Job：表示一次具体的 shader 编译请求（通常包含 shader 源、编译选项、目标平台、变体信息等）。
- FShaderCompileJob（或类似命名）：引擎内部表示单个编译请求的结构体/类。
- 编译队列：一个或多个队列用于缓存待处理的 job，支持优先级与批处理。
- Worker：执行编译的实体，可为：本地线程（线程池）、本地独立进程（`ShaderCompileWorker`）、或远程机器上的进程（分布式/远程编译）。

## 调度流程（高阶、概念性）

1. 任务创建：Material/Shader 系统在需要编译 shader 时，构建并提交 `FShaderCompileJob`。
2. 排队与合并：调度器根据目标平台、编译选项、相同输入的可重用性进行合并或去重，减少重复编译。
3. 优先级与批次：某些 job（例如当前正在编辑或运行时需要的 shader）会被提升优先级；系统可能将多个小 job 合并为批以减少开销。
4. 执行路径选择：调度器决定把 job 如何执行：
   - 本地线程池直接编译（适合快速、少量任务）；
   - 启动/投递给 `ShaderCompileWorker` 进程（在同机多进程模式下隔离编译器运行）；
   - 发送到远程 worker（在分布式编译环境下，通过网络提交并等待结果）。
5. 结果收集：完成后将编译结果（成功/失败、输出二进制/日志）返回给调度器并合并到缓存（Derived Data Cache / shader cache）。

## `ShaderCompileWorker` 的职责（概览）

- 接收编译请求（通过 IPC / 网络 /文件交换），反序列化 job 的输入。
- 在隔离环境中运行实际的 shader 编译器（例如调用平台特定的 HLSL 编译器或引擎封装的编译步骤）。
- 记录并返回编译日志、错误信息和编译产物（字节码、反射数据等）。
- 管理临时文件、超时与重试策略。
- 在分布式场景下，能够同时处理多个并发 job，并按协议返回结果给主调度端。

## 失败与重试策略（常见做法）

- 本地重试：在本地线程编译失败时，可能会简单重试或降级为更保守的编译选项。
- 切换执行器：某些错误可能会触发将 job 从本地线程切换到 `ShaderCompileWorker` 以隔离问题（或反之）。
- 超时与回收：长时间未完成的 job 会被回收并记录为超时，必要时回滚或重新提交。

## 性能与可扩展性考虑

- 批量化（batching）和去重（dedup）是减少总编译量的关键。
- 把编译交给 多核/多机 的 worker 可以线性扩展吞吐，但会引入网络/序列化开销。
- 本地进程隔离（使用 `ShaderCompileWorker` 进程）能防止编译器崩溃影响主进程，并允许为 worker 指定不同的进程环境或资源限制。

## TODO / 待补充（需要 UE5.2 精确代码引用）

- TODO: 查找并引用 UE5.2 中负责调度的具体类/函数（可能涉及 `ShaderCommonCompile`、`FShaderCompileJob`、调度器类等）。
- TODO: 查找并引用 `ShaderCompileWorker` 的具体实现路径及其 IPC/网络协议实现文件。
- TODO: 补充常见的编译器调用栈（如对 DXC/D3DCompile/clang 等的封装在引擎中的具体实现）。
- TODO: 补充具体的超时/重试参数来源与默认值（如果有）。

## 参考（待填）

- [TODO] 引擎源码：`ShaderCompileWorker.cpp` / `ShaderCommon.cpp` / `ShaderCompiler.cpp`（UE5.2 路径）
- [TODO] 相关 docs 或工程化说明

---

我已经把核心结构和待补充项写成草稿。你接下来可以：

- 把你自己的理解直接写到本文件中（在补充 TODO 部分或对应章节）；
- 或者让我去线上/本地搜索 UE5.2 源代码并把具体函数/文件引用、代码片段填进 TODO 位置（我可以继续完成）。

底部新增了 TODO 标记以便补全。欢迎指示下一步。
