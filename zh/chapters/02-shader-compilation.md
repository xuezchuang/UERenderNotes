# 着色器编译管线

## 学习目标

本章学习完成后，你将理解：
- UE5 如何将 HLSL 着色器代码编译为 GPU 字节码
- 着色器排列组合系统及其存在的原因
- Shader Map、着色器缓存及 Derived Data Cache (DDC)
- 如何优化着色器编译时间
- 着色器编译失败的调试方法

## 概述

在材质图生成 HLSL 代码（第1章）之后，该代码必须为每个目标平台进行编译。UE5 的着色器编译系统管理这一复杂的过程，处理数千个着色器变体、跨平台编译，以及缓存以加快迭代速度。

## 编译管线步骤

### 1. 着色器任务创建
**发生的事**：引擎确定需要编译哪些着色器排列组合。

**关键决定**：
- 哪些着色器类型？（顶点着色器、像素着色器、计算着色器等）
- 哪些功能级别？（ES3.1、SM5、SM6 等）
- 哪些质量设置？（低、中、高、超高）
- 启用了哪些静态开关？

### 2. 着色器编译任务分派
**发生的事**：编译任务被排队并分派。

**分派选项**：
- **本地**：在当前机器上编译
- **XGE**（Incredibuild）：跨网络分发
- **FASTBuild**：开源分布式编译
- **SN-DBS**：PlayStation 编译分发

### 3. 平台特定编译
**发生的事**：HLSL 被交叉编译为目标平台格式。

**各平台编译器**：
- **DirectX (Windows)**：DXC（DirectX 着色器编译器）
- **Vulkan**：DXC → SPIR-V（通过 SPIRV-Cross）
- **Metal (macOS/iOS)**：DXC → Metal IR
- **PlayStation**：HLSL → PSSL
- **Switch**：自定义工具链

### 4. 着色器优化
**发生的事**：编译后的着色器被优化以提高性能。

**优化项**：
- 死代码消除
- 常量折叠
- 寄存器分配
- 指令调度

### 5. 着色器映射集合
**发生的事**：编译后的着色器变体被打包到着色器映射中。

**着色器映射包含**：
- 所有顶点/像素/几何/计算着色器变体
- 着色器资源绑定（纹理、缓冲区、常量）
- 着色器元数据（指令计数、资源使用情况）

### 6. 缓存
**发生的事**：结果存储在 DDC 中以加快迭代。

**缓存位置**：
- **本地 DDC**：`<项目>/Saved/DDC/`
- **共享 DDC**：网络位置（S3、文件共享）
- **派生数据**：源更改时重新生成
